---
title: "Aim_2_Script"
author: "Gerard Garcia and Emilia Vachon"
date: "2025-11-17"
output: html_document
---

# Load necessary packages to perform core microbiome, indicator taxa, and ANCOM-BC2 analyses

Seeing as we have already performed analyses using these packages in class, this step differs from the Aim Specific Approach in the Project Proposal, which was to install the packages below.

```{r packages, echo = FALSE}

library(tidyverse)
library(phyloseq)
library(ggplot2)
library(vegan)
library(ggVennDiagram)
library(microbiome)
library(indicspecies)
library(ANCOMBC)
```

# Load phyloseq and name as object

As the phyloseq object is required for multiple aims, it was first created separately and added to the GitHub repository. This steps loads the phyloseq object and assigns it a name, rather than creating it as outlined in the Project Proposal.

```{r phyloseq}

ps <- readRDS("../phyloseq_taxonomy.rds")
```

# Subset the phyloseq data

```{r subset}

ps_abundance <- transform_sample_counts(ps, fun = function(x) x/sum(x))


rrms_nd <- subset_samples(ps_abundance, disease_type == "RRMS" & depression == 0)

rrms_d <- subset_samples(ps_abundance, disease_type == "RRMS" & depression == 1)

pms_nd <- subset_samples(ps_abundance, disease_type == "PMS" & depression == 0)

pms_d <- subset_samples(ps_abundance, disease_type == "PMS" & depression == 0)

control_nd <- subset_samples(ps_abundance, disease_type == "Control" & depression == 0)

control_d <- subset_samples(ps_abundance, disease_type == "Control" & depression == 1)
```

# Perform core microbiome assessment for each subsetted group

```{r core microbiome}

rrms_nd_core <- core_members(rrms_nd, detection = 0, prevalence = 0.8)

rrms_d_core <- core_members(rrms_d, detection = 0, prevalence = 0.8)

pms_nd_core <- core_members(pms_nd, detection = 0, prevalence = 0.8)

pms_d_core <- core_members(pms_d, detection = 0, prevalence = 0.8)

control_nd_core <- core_members(control_nd, detection = 0, prevalence = 0.8)

control_d_core <- core_members(control_d, detection = 0, prevalence = 0.8)
```

# Visualize core microbiomes based on MS severity

```{r visualize}

pms_core_diagram <- ggVennDiagram(x = list(pms_nd_core, pms_d_core, control_nd_core, control_d_core), set_size = 3,
              category.names = c("PMS", "PMS and depression", "Control", "Control and depression"),
              label_color = "white")

pms_core_diagram

rrms_core_diagram <- ggVennDiagram(x = list(rrms_nd_core, rrms_d_core, control_nd_core, control_d_core), set_size = 3,
              category.names = c("RRMS", "RRMS and depression", "Control", "Control and depression"),
              label_color = "white")

rrms_core_diagram

rrms_only_core_diagram <- ggVennDiagram(x = list(rrms_nd_core, rrms_d_core), set_size = 3,
              category.names = c("RRMS", "RRMS and depression"),
              label_color = "white")

rrms_only_core_diagram

pms_only_core_diagram <- ggVennDiagram(x = list(pms_nd_core, pms_d_core), set_size = 3,
              category.names = c("PMS", "PMS and depression"),
              label_color = "white")

pms_only_core_diagram
```

# Perform indicator species analysis

```{r}

phyloseq_object = subset_samples(ps, depression == 0 | depression == 1) %>%
  microbiome::transform('compositional')

grouped_data <- data.frame(phyloseq_object@sam_data) %>%
  mutate(group = case_when(
    disease_type == "RRMS" & depression == 0 ~ "RRMS",
    disease_type == "RRMS" & depression == 1 ~ "RRMS Depression",
    disease_type == "PMS" & depression == 0 ~ "PMS",
    disease_type == "PMS" & depression == 1 ~ "PMS Depression",
    disease_type == "Control" & depression == 0 ~ "Control",
    disease_type == "Control" & depression == 1 ~ "Control Depression")) 



phyloseq_object@sam_data <- sample_data(grouped_data)

isa_output = multipatt(t(otu_table(phyloseq_object)), 
                       cluster = sample_data(phyloseq_object)$group,
                       control = how(nperm = 999))

statistics = as.data.frame(isa_output$sign)

summary(isa_output, indvalcomp = TRUE)

write.csv(statistics, 'isa_table.csv')

isa_filtered = filter(statistics, stat > 0.5 & p.value < 0.05)

write.csv(isa_filtered, "isa_filtered.csv")

dim(isa_filtered)

# Plot the two taxa that are indicators for the gut

df_of_taxa = prune_taxa(isa_filtered) %>% psmelt()

df_of_taxa %>% 
  ggplot(aes(body.site,Abundance,fill=body.site)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(height=0, width=0.2) +
  facet_wrap(~Phylum, ncol = 4, scales = 'free')
```

Ancomb2

```{r}

ps_ancomb2 <- ps 


grouped_data <- data.frame(ps_ancomb2@sam_data) %>%
  mutate(group = case_when(
    disease_type == "RRMS" & depression == 0 ~ "RRMS",
    disease_type == "RRMS" & depression == 1 ~ "RRMS Depression",
    disease_type == "PMS" & depression == 0 ~ "PMS",
    disease_type == "PMS" & depression == 1 ~ "PMS Depression",
    disease_type == "Control" & depression == 0 ~ "Control",
    disease_type == "Control" & depression == 1 ~ "Control Depression")) |>
  filter(group == "PMS" | group == "PMS Depression")

ps_ancomb2@sam_data <- sample_data(grouped_data)

species_glom <- tax_glom(ps_ancomb2, 'Species')

data2 <- species_glom@sam_data

out <- ancombc2(data = species_glom,
                fix_formula = 'group',
                p_adj_method = 'BH',
                prv_cut = 0.1)
statistical_table = out$res

filtered_stat <- statistical_table |>
  filter(`diff_robust_groupPMS Depression` == "TRUE" )


#filtered_stat |>
#  ggplot(aes(taxon, lfc_groupPMS, fill = taxon)) + 
 # geom_col() +
#coord_flip() +
#  ggtitle("Significant Differences in Abundance for Species in PMS") +
#  labs(x = "Bacterial Species", y = "Bacterial Abundance")

#print()
          
  
                
```
