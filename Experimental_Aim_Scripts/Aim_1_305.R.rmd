# Aim 1 Team A 
## making the phyloseq 
```{r}
library(phyloseq)
library(tidyverse)
library(vegan)
library(dplyr)
library(ggplot2)
library(picante)
library(FSA)
library(ggpubr)

```


```{r}
taxonomy <- read.delim("taxonomy.tsv", row.names = 1)
tree <- read_tree("tree.nwk")
counts <- read.delim("feature-table.tsv", skip = 1, row.names = 1)
metadata <- read.delim("new_metadata.tsv", row.names = 1)


taxonomy_formatted = taxonomy %>% 
  separate(col = Taxon, 
           into = c('Domain','Phylum','Class','Order',
                    'Family','Genus','Species'),
           sep=';', fill='right') %>% 
  select(-Confidence) %>% 
  as.matrix()

counts_formatted = counts %>% as.matrix()
colnames(counts_formatted) <- sub("^X", "", colnames(counts_formatted))
colnames(counts_formatted) <- gsub("\\.", "-", colnames(counts_formatted))


meta_data <- read.delim(
  "new_metadata.tsv",
  sep = "\t",
  header = TRUE,
  row.names = 1,
  check.names = FALSE,
  comment.char = ""
)
meta_data <- meta_data[colnames(counts_formatted), ]


ps <- phyloseq(
  sample_data(meta_data),
  otu_table(counts_formatted, taxa_are_rows = TRUE),
  tax_table(taxonomy_formatted),
  tree
)

saveRDS(ps,'phyloseq_taxonomy.rds')
```

```{r}
ps <- readRDS("../phyloseq_taxonomy.rds")
```


## starting with alpha diversity analysis 
### splitting data
```{r}
set.seed(421)
psrare = ps %>% rarefy_even_depth(sample.size = 7000, rngseed = 421)

meta_r <- data.frame(sample_data(psrare))
meta_r$depression <- as.numeric(as.character(meta_r$depression)) # pull metadata to allow for better manipulation

meta_r$group6 <- with(
  meta_r,
  case_when(
    disease_type == "RRMS"    & depression == 1 ~ "RRMS_Depression",
    disease_type == "RRMS"    & depression == 0 ~ "RRMS_NoDepression",
    disease_type == "PMS"     & depression == 1 ~ "PMS_Depression",
    disease_type == "PMS"     & depression == 0 ~ "PMS_NoDepression",
    disease_type == "Control" & depression == 1 ~ "NoMS_Depression",
    disease_type == "Control" & depression == 0 ~ "NoMS_NoDepression",
    TRUE ~ NA_character_
  ) # making the 6 groups 
)

meta_r$group6 <- factor(
  meta_r$group6,
  levels = c("RRMS_Depression",
             "RRMS_NoDepression",
             "PMS_Depression",
             "PMS_NoDepression",
             "NoMS_Depression",
             "NoMS_NoDepression")
) # adding levels based on how they will show up in graph NO BIOLOGICAL RANKING

sample_data(psrare) <- sample_data(meta_r) # adding this new metadata back to our phyloseq
```
### running faiths
```{r}
psrare_noNA <- subset_samples(psrare, !is.na(group6))
psrare_noNA <- prune_samples(sample_sums(psrare_noNA) > 0, psrare_noNA) # removes NA and empties

otu_mat <- as(otu_table(psrare_noNA), "matrix") # extracting OTU and making sure rows are sample and cols are taxa 
if (taxa_are_rows(psrare_noNA)) {
  otu_mat <- t(otu_mat)
}
tree_pd <- phy_tree(psrare_noNA) # extracting tree 
faith_pd <- pd(otu_mat, tree_pd, include.root = TRUE) # calculating faiths 
meta_r <- data.frame(sample_data(psrare_noNA))
meta_r <- meta_r[rownames(faith_pd), , drop = FALSE]

faith_df <- data.frame(
  sample  = rownames(faith_pd),
  FaithPD = faith_pd$PD,
  group6  = meta_r$group6
) # build final clean table for plotting 
```
### making faiths plot
```{r}
faiths_plot <- ggplot(faith_df, aes(x = group6, y = FaithPD, color = group6)) +
  geom_boxplot(outlier.shape = NA) +          # boxplot without showing outlier duplicates
  geom_jitter(width = 0.2, size = 2, alpha = 0.7) +   
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("Faith's Phylogenetic Diversity") +
  xlab("MS / Depression Group") +
  scale_color_discrete(name = "Group") + 
  ggtitle("Faith's PD Across MS / Depression Groups")

faiths_plot

```
### making shannon/observed plot
```{r}
set.seed(421)
p = plot_richness(psrare_noNA, x = 'group6', 
                  measures = c('Observed','Shannon','Chao1','Simpson'),
                  color = 'group6',
                  )
pdata = p$data
str(pdata)

p_alpha <- pdata %>% 
  ggplot(aes(x = group6, y = value, fill = group6)) +
  geom_boxplot(outlier.shape = NA, width = 0.6, alpha = 0.7, colour = "black") +
  geom_jitter(aes(colour = group6),
              width = 0.2, height = 0,
              size = 1.8, alpha = 0.6) +
    theme_classic(base_size = 18) +
  facet_wrap(~variable, ncol = 4, scales = "free_y") +
  ylab("Alpha Diversity") + 
  xlab(NULL) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(fill = "Group", colour = "Group", title = "Alpha Diversity Measures Across MS / Depression Groups") +
 scale_fill_brewer(palette = "Set2") +
  scale_colour_brewer(palette = "Set2")

p_alpha
```
### calculating significance for alpha diversity values
```{r}

set.seed(421)

run_dunn <- function(df, metric, value_col = "value") {
  tmp <- df

  res <- dunnTest(as.formula(paste0(value_col, " ~ group6")),
                  data = tmp, method = "bh")$res # this just shows that you are running the Dunn test based on this formula, res extracts the results

  res <- as.data.frame(res)
  assign(paste0("Dunn_", metric), res, envir = .GlobalEnv)
  
  sig <- res %>% filter(P.adj < 0.05)
  assign(paste0("Dunn_", metric, "_sig"), sig, envir = .GlobalEnv) # creates only a significant table
  
  return(list(all = res, sig = sig)) # this function we made returns everything 
} # making a helper function to make sure everything saves in a dataframe

metrics <- c("Observed", "Shannon", "Chao1", "Simpson")

Dunn_results <- list()

for (m in metrics) {
  cat("\nRunning Dunn test for", m, "...\n")
  df_m <- subset(pdata, variable == m)
  Dunn_results[[m]] <- run_dunn(df_m, m)
} # doing dunn test for values using the function we made above so that it saves how we like

Dunn_FaithPD <- dunnTest(FaithPD ~ group6, data = faith_df, method = "bh")$res
Dunn_FaithPD_sig <- Dunn_FaithPD %>% filter(P.adj < 0.05) # doing dunn test for faiths

# save them the same way
assign("Dunn_FaithPD", Dunn_FaithPD, envir = .GlobalEnv)
assign("Dunn_FaithPD_sig", Dunn_FaithPD_sig, envir = .GlobalEnv)

all_sig <- bind_rows(
  Dunn_Observed_sig  %>% mutate(Metric = "Observed"),
  Dunn_Shannon_sig   %>% mutate(Metric = "Shannon"),
  Dunn_Chao1_sig     %>% mutate(Metric = "Chao1"),
  Dunn_Simpson_sig   %>% mutate(Metric = "Simpson"),
  Dunn_FaithPD_sig   %>% mutate(Metric = "FaithPD")
)

assign("Dunn_All_Significant", all_sig, envir = .GlobalEnv)
rm(all_sig) # just wanted a better name
```
This tells us that overall, only 2 groups had significant differences in alpha diversity metrics
## annotating the original graph to show these differences 
```{r}
p_obs <- Dunn_Observed_sig$P.adj

p_chao <- Dunn_Chao1_sig$P.adj # pulling the significant comparisons 

max_vals <- pdata %>% 
  group_by(variable) %>% 
  summarise(max_val = max(value, na.rm = TRUE))

max_obs  <- max_vals$max_val[max_vals$variable == "Observed"]
max_chao <- max_vals$max_val[max_vals$variable == "Chao1"] # deciding height 

sig_df <- data.frame(
  variable   = c("Observed", "Chao1"),
  group1     = c("PMS_Depression", "PMS_Depression"),
  group2     = c("PMS_NoDepression", "PMS_NoDepression"),
  y.position = c(max_obs  + 10,     
                 max_chao + 0.2),
  p.adj      = c(p_obs, p_chao)
) 
sig_df$label <- paste0("p = ", signif(sig_df$p.adj, 3)) # table describing significant annotations 

p_formatted_alpha_annot <- p_formatted +
  stat_pvalue_manual(
    sig_df,
    label = "label",       
    tip.length = 0.01,
    bracket.size = 0.5,
    hide.ns = FALSE       
  )

p_formatted_alpha_annot
```
Overall, not too many significant differences for alpha diversity metrics, but it seems like PMS depression vs PMS no depression indicate significant differences. 
## Running the beta diversity metrics 
### organization
```{r}
meta <- data.frame(sample_data(psrare_noNA))

bray <- distance(psrare_noNA, method = "bray")
unwUF<- UniFrac(psrare_noNA, weighted = FALSE, normalized = TRUE)
wUF <- UniFrac(psrare_noNA, weighted = TRUE,  normalized = TRUE)
```
### running permanova
```{r}
adonis_unw <- adonis2(unwUF ~ group6,
                      data = meta,
                      permutations = 999)
adonis_w <- adonis2(wUF ~ group6,
                    data = meta,
                    permutations = 999)
adonis_bray  <- adonis2(bray  ~ group6, 
                      data = meta, 
                      permutations = 999)
adonis_unw
adonis_w
adonis_bray
```
The results here show us each test reveals significance, we will now run pairwise
### Pairwise Permanova
```{r}
pairwise_permanova <- function(dist_matrix, groups, nperm = 999) {
  require(vegan)

  groups <- as.factor(groups)
  combos <- combn(levels(groups), 2)
  
  results <- data.frame(
    group1 = combos[1, ],
    group2 = combos[2, ],
    R2 = NA,
    p = NA
  )

  for (i in seq_len(ncol(combos))) {
    g1 <- combos[1, i]
    g2 <- combos[2, i]

    # subset samples to these two groups
    idx <- groups %in% c(g1, g2)
    sub_dist <- dist_matrix[idx, idx]
    sub_groups <- groups[idx]

    # run permanova
    ad <- adonis2(sub_dist ~ sub_groups, permutations = nperm)
    
    results$R2[i] <- ad$R2[1]
    results$p[i]  <- ad$`Pr(>F)`[1]
  }

  results$p.adj <- p.adjust(results$p, method = "BH")
  return(results)
} # creating a permanova helper function since pairwiseAdonis doesnt exist on my R
```
### Making our tables
```{r}
pw_bray <- pairwise_permanova(as.matrix(bray), meta$group6)

pw_unwUF <- pairwise_permanova(as.matrix(unwUF), meta$group6)

pw_wUF <- pairwise_permanova(as.matrix(wUF), meta$group6)

pw_bray_sig  <- pw_bray  %>% filter(p.adj < 0.05)
pw_unwUF_sig <- pw_unwUF %>% filter(p.adj < 0.05)
pw_wUF_sig   <- pw_wUF   %>% filter(p.adj < 0.05)

pairwise_all <- bind_rows(
  pw_bray  %>% mutate(Metric = "Bray-Curtis"),
  pw_unwUF %>% mutate(Metric = "Unweighted UniFrac"),
  pw_wUF   %>% mutate(Metric = "Weighted UniFrac")
)

pairwise_all

pairwise_sig <- pairwise_all %>% 
  filter(p.adj < 0.05) %>%             
  arrange(Metric, p.adj) 

pairwise_sig
```

### Plotting unweighted
```{r}
ord_unw <- ordinate(psrare_noNA, method = "PCoA", distance = unifrac_unw)
# ordination of the phyloseq to allow for visualization of the matrix, meathod is PCoA

p_unw <- plot_ordination(psrare_noNA, ord_unw,
                         color = "group6") +
  geom_point(size = 2, alpha = 0.7) +
  stat_ellipse(size = 1) +
  scale_color_brewer(palette = "Set2", name = "Group") +
  theme_classic(base_size = 18) +
  ggtitle("PCoA – Unweighted UniFrac") +
  annotate("text",
           x = min(ord_unw$vectors[,1]) + 0.02,
           y = max(ord_unw$vectors[,2]) - 0.02,
           label = paste0("PERMANOVA (UnwUF): p = ", signif(adonis_unw$`Pr(>F)`[1], 3)),
           size = 6)
p_unw
```
### Plotting weighted
```{r}

ord_w <- ordinate(psrare_noNA, method = "PCoA", distance = unifrac_w)

p_w <- plot_ordination(psrare_noNA, ord_w,
                       color = "group6") +
  geom_point(size = 2, alpha = 0.7) +
  stat_ellipse(size = 1) +
  scale_color_brewer(palette = "Set2", name = "Group") +
  theme_classic(base_size = 18) +
  ggtitle("PCoA – Weighted UniFrac") +
   annotate("text",
           x = min(ord_w$vectors[,1]) + 0.02,
           y = max(ord_w$vectors[,2]) - 0.02,
           label = paste0("PERMANOVA (Bray): p = ", signif(adonis_w$`Pr(>F)`[1], 3)),
           size = 6)

p_w
```
### Plotting Bray
```{r}
# Plot it
ord_bray <- ordinate(psrare_noNA, method = "PCoA", distance = "bray")

plot_Bray <- plot_ordination(psrare_noNA, ord_bray, color = "group6") +
  geom_point(size = 2, alpha = 0.7) +
  stat_ellipse(size = 1) +
  scale_color_brewer(palette = "Set2", name = "Group") +
  theme_classic(base_size = 18) +
  ggtitle("PCoA – Bray–Curtis Dissimilarity") +
    annotate("text",
           x = min(ord_bray$vectors[,1]) + 0.02,
           y = max(ord_bray$vectors[,2]) - 0.02,
           label = paste0("PERMANOVA (Bray): p = ", signif(adon_bray$`Pr(>F)`[1], 3)),
           size = 6)

plot_Bray
```
Overall, each of the beta diversity metrics had a significant global p value, but only Bray and unweighted had significant pairwise differences between groups. 